<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.230">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Isaac Quintanilla Salinas">
  <meta name="description" content="Tutorial for parallel processing using the R package parallel.">
  <title>STAT COMP - Parallel Computing in R with parallel</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <script src="../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../site_libs/clipboard/clipboard.min.js"></script>
  <meta name="quarto:offset" content="../">
  <script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="../site_libs/quarto-search/fuse.min.js"></script>
  <script src="../site_libs/quarto-search/quarto-search.js"></script>
  <script src="../site_libs/quarto-html/quarto.js"></script>
  <script src="../site_libs/quarto-html/popper.min.js"></script>
  <script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../site_libs/quarto-html/anchor.min.js"></script>
  <link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link id="quarto-text-highlighting-styles" href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script id="quarto-search-options" type="application/json">{
    "location": "navbar",
    "copy-button": false,
    "collapse-after": 3,
    "panel-placement": "end",
    "type": "overlay",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body class="nav-fixed fullcontent">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">STAT COMP</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../hpcc.html">HPCC</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_tutorials.html">R</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../python_tutorials.html">Python</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../submission.html">Submissions</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://ucrgradstat.github.io/">STAT GSA</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ucrgradstat/stat_comp"><i class="bi bi-fa-github fa-lg" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">
<header id="title-block-header" class="quarto-title-block default">



<div class="quarto-title"><h1 class="title display-7">Parallel Computing in R with <code>parallel</code></h1><div class="quarto-description"><p>Tutorial for parallel processing using the R package parallel.</p></div></div><div class="quarto-title-meta"><div><div class="quarto-title-meta-heading">Author</div><div class="quarto-title-meta-contents"><div class="quarto-title-authors"><div><div>
<p>Isaac Quintanilla Salinas</p>
</div></div></div></div></div><div><div class="quarto-title-meta-heading">Published</div><div class="quarto-title-meta-contents"><p class="date">May 7, 2022</p></div></div></div></header>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>R is designed to only use one cpu (or core) when running tasks. However, a computer may have more than one core that can be used to run tasks. The use of more than one core is known as parallel computing in R. The goal of this tutorial is to provide the basics of using the <code>parallel</code> package and utilizing more cores in a computer.</p>
<p>For more information about parallel processing in R, visit the following sites:</p>
<ul>
<li><a href="https://nceas.github.io/oss-lessons/parallel-computing-in-r/parallel-computing-in-r.html">https://nceas.github.io/oss-lessons/parallel-computing-in-r/parallel-computing-in-r.html</a></li>
<li><a href="https://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html">https://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html</a></li>
<li><a href="https://psu-psychology.github.io/r-bootcamp-2018/talks/parallel_r.html">https://psu-psychology.github.io/r-bootcamp-2018/talks/parallel_r.html</a></li>
</ul>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<p>The <code>parallel</code> package allows you to use multiple cpus at the same time to complete repetitive tasks. For example, if you have to run a simulation study with 100 data sets, you can task 4 cpus to analyze 25 data sets at the same time. This ideally will take a forth of the time it will take 1 cpu to complete 100 data sets.</p>
<p>The only caveaut with using the <code>parallel</code> package is that each process needs to be independent of all processes. If you are running a for loop that depends on the previous iteration, the cpu cannot process the task because it has missing information. Therefore, you will need identify the tasks that are not dependent of one another and parallelize it.</p>
<p>With the parallel package you can use two family of functions: <code>mc*()</code> and <code>par*()</code> functions. The main difference between these functions is that <code>mc*()</code> uses a forking method to parallelize your code, and the <code>par*()</code> uses a socket method to parallelize your code. Both methods has their strengths and weaknesses. When using the HPCC cluster, I recommend using the <code>mc*()</code> functions when possible. There are brief descriptions for each method below.</p>
<section id="forking" class="level2">
<h2 class="anchored" data-anchor-id="forking">Forking</h2>
<p>The forking method is implemented when using the <code>mc*()</code> functions. Below is a list of pros and cons:</p>
<section id="pros" class="level3">
<h3 class="anchored" data-anchor-id="pros">Pros:</h3>
<ul>
<li><p>Easier to implement</p></li>
<li><p>Your environment is copied to the cpu</p></li>
<li><p>Has the potential to use less resources</p></li>
<li><p>Wraps USER function with the <code>try()</code> function</p></li>
</ul>
</section>
<section id="cons" class="level3">
<h3 class="anchored" data-anchor-id="cons">Cons:</h3>
<ul>
<li><p>Only works on POSIX systems (Mac or Linux)</p></li>
<li><p>Does not work with multiple nodes<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p></li>
<li><p>May cause cross-contamination because the environment may change<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p></li>
</ul>
<p>Generally speaking, R copies its environment to a cpu and runs the process.</p>
</section>
</section>
<section id="socket" class="level2">
<h2 class="anchored" data-anchor-id="socket">Socket</h2>
<p>The socket method is implemented when using the <code>par*()</code> functions. Below is a list of pros and cons:</p>
<section id="pros-1" class="level3">
<h3 class="anchored" data-anchor-id="pros-1">Pros:</h3>
<ul>
<li><p>Works on any system (Windows, Mac, and Linux)</p></li>
<li><p>Each process is unique</p></li>
<li><p>No cross-contamination</p></li>
<li><p>Can be used when multiple nodes are involved</p></li>
</ul>
</section>
<section id="cons-1" class="level3">
<h3 class="anchored" data-anchor-id="cons-1">Cons:</h3>
<ul>
<li><p>The entire environment (including loaded functions) must be specified</p></li>
<li><p>More resource intensive</p></li>
<li><p><code>try()</code> function is not implemented, when one cpu fails, the entire cluster fails</p></li>
</ul>
<p>Generally speaking, R creates a new environment on each cpu.</p>
</section>
</section>
<section id="where-to-parallelize" class="level2">
<h2 class="anchored" data-anchor-id="where-to-parallelize">Where to parallelize?</h2>
<p>Parallel computing requires repetitive tasks to be independent of each other. The results from one task must not be used as input for another task. Therefore, identify blocks of code where repetition is involved. This can be either <code>for</code> loops or <code>*apply()</code> functions.</p>
<p>Other locations to parallelize your code are bottlenecks. Having multiple cores processing bottlenecks helps speed up your code. For more information about bottlenecks or code efficiency, visit the Advanced R website: <a href="https://adv-r.hadley.nz/">adv-r.hadley.nz</a>.</p>
<p>Identifying the location to parallelize may be challenging due to so many options. My advice is to try many things and see what provides the best result.</p>
</section>
</section>
<section id="simulation-example" class="level1">
<h1>Simulation Example</h1>
<p>To demonstrate how to use the <code>parallel</code> package in R, we conduct a simple simulation study showing how the estimates from the ordinary least squares estimator leads to unbiased results.</p>
<p><span class="math display">\[
Y \sim N(\beta_0+X_1\beta_1+X_4\beta_5+X_3\beta_3,\sigma^2)
\]</span></p>
<section id="simulation-functions" class="level2">
<h2 class="anchored" data-anchor-id="simulation-functions">Simulation Functions</h2>
<p>The function below generates data from the model above and returns a data frame.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-1_9d65a58fef68c2b1b4c142d65743c8b5">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>data_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(seed, nobs, beta, sigma, xmeans, xsigs){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  xrn <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(nobs, <span class="at">mean =</span> xmeans, <span class="at">sigma =</span> xsigs)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  xped <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="dv">1</span>,nobs),xrn)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> xped <span class="sc">%*%</span> beta <span class="sc">+</span> <span class="fu">rnorm</span>(nobs ,<span class="dv">0</span>, sigma)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x=</span>xrn, <span class="at">y=</span>y)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function needs the following arguments:</p>
<ul>
<li><code>seed</code>: the value to set for the random number generator</li>
<li><code>nobs</code>: number of observations</li>
<li><code>beta</code>: a vector specifying the true values for the regression coefficients (<span class="math inline">\(\beta_0\)</span>, <span class="math inline">\(\beta_1\)</span>, <span class="math inline">\(\beta_2\)</span>, <span class="math inline">\(\beta_3\)</span>)</li>
<li><code>sigma</code>: the variance for the model above</li>
<li><code>xmeans</code>: a vector of means used to generate the values for <span class="math inline">\(X_1\)</span>, <span class="math inline">\(X_2\)</span>, and <span class="math inline">\(X_3\)</span></li>
<li><code>xsigs</code>: a matrix for the covariance for <span class="math inline">\(X_1\)</span>, <span class="math inline">\(X_2\)</span>, and <span class="math inline">\(X_3\)</span></li>
</ul>
<p>The function below takes the data generated from the <code>data_sim()</code> and fits a linear regression model. The function wraps around the <code>lm()</code> function and returns estimated regression coefficients.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-2_37a1608cc94d2e8b1d6513d9753c0c88">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>parallel_lm <span class="ot">&lt;-</span> <span class="cf">function</span>(data){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  lm_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x<span class="fl">.1</span> <span class="sc">+</span> x<span class="fl">.2</span> <span class="sc">+</span> x<span class="fl">.3</span>, <span class="at">data =</span> data)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">coef</span>(lm_res))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="loading-r-packages" class="level3">
<h3 class="anchored" data-anchor-id="loading-r-packages">Loading R Packages</h3>
<p>For this tutorial, you will need the <code>parallel</code> and <code>mvtnorm</code> packages.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-3_200ba160dbb296ed3d995adf6e18c362">
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-parameters" class="level3">
<h3 class="anchored" data-anchor-id="setting-parameters">Setting Parameters</h3>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-4_5505019ecf48098e83715fcc8c7ba4e0">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>nobs <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">3</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>xmeans <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>xsigs <span class="ot">&lt;-</span><span class="fu">diag</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>sig <span class="ot">&lt;-</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulating-data" class="level3">
<h3 class="anchored" data-anchor-id="simulating-data">Simulating Data</h3>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-5_9674ac89f0665389ebd00da3f8c104ee">
<div class="sourceCode" id="cb5"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>parallel_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), data_sim,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nobs =</span> nobs, <span class="at">beta =</span> beta, <span class="at">sigma =</span> sig, <span class="at">xmeans =</span> xmeans, <span class="at">xsigs =</span> xsigs)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>()<span class="sc">-</span>start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>Time difference of 2.546581 secs</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="parallelization" class="level1">
<h1>Parallelization</h1>
<section id="detecting-cores" class="level2">
<h2 class="anchored" data-anchor-id="detecting-cores">Detecting Cores</h2>
<p>The <code>parallel</code> package has a function that can detect the number of cores available on your computer. Use the <code>detectCores()</code> function to find how many cpus your computer has<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-6_d813676d6fe5e88a93de75bb438aefc3">
<div class="sourceCode" id="cb7"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">detectCores</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>[1] 8</code></pre>
</div>
</div>
<p>For this example, I will use 8 cpus. You can change the number of cpus based on your computer.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-7_5ae6e0194612e042df43d6827af38e1d">
<div class="sourceCode" id="cb9"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">&lt;-</span> <span class="dv">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="using-lapply" class="level2">
<h2 class="anchored" data-anchor-id="using-lapply">Using <code>lapply()</code></h2>
<p>Before we parallelize, use the <code>lapply()</code> function to run the simulation on one cpu.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-8_746030cb7192dbe1ea55988efb53756d">
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lapply_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(parallel_data, parallel_lm)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>(lapply_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()<span class="sc">-</span>start)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>Time difference of 4.205292 secs</code></pre>
</div>
</div>
</section>
<section id="using-mclapply" class="level2">
<h2 class="anchored" data-anchor-id="using-mclapply">Using <code>mclapply()</code></h2>
<p>The easiest way to parallelize is to use the <code>mclapply()</code> function. All you need to do is change the <code>lapply()</code> function to <code>mclapply()</code> and add the argument <code>mc.cores =  ncores</code> as the last argument. The argument <code>mc.cores</code> specifies the number of cores for parallelization.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-9_749e14f9e744e9801f4bc06297489f30">
<div class="sourceCode" id="cb12"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>mclapply_results <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(parallel_data, parallel_lm, <span class="at">mc.cores =</span> ncores)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>(mclapply_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()<span class="sc">-</span>start)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>Time difference of 1.333008 secs</code></pre>
</div>
</div>
</section>
<section id="using-parlapply" class="level2">
<h2 class="anchored" data-anchor-id="using-parlapply">Using <code>parLapply()</code></h2>
<section id="functions" class="level3">
<h3 class="anchored" data-anchor-id="functions">Functions</h3>
<p>Using <code>parLapply()</code> function requires setting up the cluster. There are two functions needed to set up the cluster: <code>makeCluster()</code> and <code>clusterExport()</code>. Once your analysis is finished, you will need to close the cluster using the <code>stopCluster()</code> function.</p>
<section id="makecluster" class="level4">
<h4 class="anchored" data-anchor-id="makecluster"><code>makeCluster()</code></h4>
<p>The <code>makeCluster()</code> function sets up the cluster in your computer. You only need to specify the number of cores to use (<code>ncores</code>) and store it in an R object (<code>cl</code>)</p>
</section>
<section id="clusterexport" class="level4">
<h4 class="anchored" data-anchor-id="clusterexport"><code>clusterExport()</code></h4>
<p>The <code>clusterExport()</code> function is needed to export user-created functions, package functions, or data to the cluster. You will need to specify the cluster (<code>cl</code>) to export the information and the name of the functions or data in a character vector.</p>
</section>
<section id="parlapply" class="level4">
<h4 class="anchored" data-anchor-id="parlapply"><code>parLapply()</code></h4>
<p>The <code>parLapply()</code> is the parallel computing component. It is used the same way as the <code>lapply()</code> function. The only difference is that you will need to specify the cluster (<code>cl</code>) as the first argument. The second argument goes as the <code>lapply()</code> function.</p>
</section>
<section id="stopcluster" class="level4">
<h4 class="anchored" data-anchor-id="stopcluster"><code>stopCluster()</code></h4>
<p>The <code>stopCluster()</code> function closes the cluster down.</p>
</section>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<p>The code below implements the <code>parLapply()</code> function:</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-10_7ef7372c7a48b92147612ca6f34f57ca">
<div class="sourceCode" id="cb14"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterExport</span>(cl, <span class="fu">c</span>(<span class="st">"parallel_lm"</span>))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>parLapply_results<span class="ot">&lt;-</span><span class="fu">parLapply</span>(cl,parallel_data,parallel_lm)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>(parLapply_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()<span class="sc">-</span>start)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>Time difference of 1.748807 secs</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>Since all the results are in a list, we will first convert them into a matrix:</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-11_0e10e464a9f85a8f587b0a0514c3f307">
<div class="sourceCode" id="cb16"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>lapply_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(lapply_results), <span class="at">nrow =</span> <span class="dv">4</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mclapply_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(mclapply_results), <span class="at">nrow =</span> <span class="dv">4</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>parLapply_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(parLapply_results), <span class="at">nrow =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the <code>rowMeans()</code> on all objects to show each method provides consistent estimates of the regression parameters.</p>
<div class="cell" data-hash="parallel_notebook_cache/html/unnamed-chunk-12_5e5978b9167df59c6a27193e32c77fc4">
<div class="sourceCode" id="cb17"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rowMeans</span>(lapply_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>[1]  4.999838  4.000874 -4.999656 -2.996343</code></pre>
</div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rowMeans</span>(mclapply_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>[1]  4.999838  4.000874 -4.999656 -2.996343</code></pre>
</div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rowMeans</span>(parLapply_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>[1]  4.999838  4.000874 -4.999656 -2.996343</code></pre>
</div>
</div>
</section>
<section id="notes" class="level1">
<h1>Notes</h1>
<section id="speed-gains" class="level2">
<h2 class="anchored" data-anchor-id="speed-gains">Speed Gains</h2>
<p>When parallelizing your code, the speed gains may not be noticeable. When using the <code>parallel</code> package, R assigns elements of a list or vector into different cores, known as overhead, which takes time. The time it takes to load the data may be longer than processing the data. Therefore, it may not be faster or take longer than using the <code>*apply()</code> functions. It may be best to use one core or split up the data on your own. However, when processing your data takes much longer than your overhead time, the speed gains are noticeable.</p>
</section>
<section id="hyper-threading" class="level2">
<h2 class="anchored" data-anchor-id="hyper-threading">Hyper-threading</h2>
<p>Certain computer processors have cores that are multi-threaded (hyper-threading). This means the computer views 1 physical core as 2 logical cores. While you certainly specify double the number of physical cores for your cluster, the speed gains is not equivalent as using proper physical cores. In my experience, it is not worth using the logical cores and just specify the number of physical cores in your computer.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>You can think of as nodes as the processor. Each processor has a set number of cpus, if you need more cpus, you will need to use another node.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Mostly occurs with random number generation; however, this is generally not a problem.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>The function provides the number of logical cores and not physical cores. This is due to multithreading.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->


</body></html>